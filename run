#!/bin/bash

# SPDX-FileCopyrightText: Alliander N. V.
# 
# SPDX-License-Identifier: Apache-2.0

SCRIPT_PATH=$(
    cd "$(dirname "${BASH_SOURCE[0]}")" || exit
    pwd -P
)

images=()
for dockerfile in $SCRIPT_PATH/dockerfiles/*.Dockerfile; do
    images+=("$(basename "${dockerfile%.*}")")
done
[[ -z $images ]] && echo "No Dockerfiles found" && return 1
echo "Select image #: "
select image in "${images[@]}" ; do
    [[ $image ]] && break
done

# origins=(DockerHub local)
# echo "Image origin #: "
# select origin in "${origins[@]}" ; do
#     [[ $origin ]] && break
# done

if [[ $origin == "DockerHub" ]]; then
    branch_name=$(git branch --show-current)
    if [[ $branch_name == main ]]; then
        img_tag=latest
    else
        modified_branch_name=${branch_name/\//-}
        img_tag=$modified_branch_name-latest
    fi
else
    img_tag=$origin
fi
export IMAGE_TAG=$img_tag

mkdir -p ~/.vscode-server
mkdir -p $SCRIPT_DIR_PATH/.config
touch $SCRIPT_DIR_PATH/.personal.bashrc

echo Running $image:$IMAGE_TAG ...
docker compose -f $SCRIPT_PATH/.devcontainer/docker-compose.yml run --rm $image
