# SPDX-FileCopyrightText: Alliander N. V.
#
# SPDX-License-Identifier: Apache-2.0

name: workspace

on:
  workflow_call:
    inputs:
      container-image:
        type: string
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Clear disk space
        run: |
          df -h /
          sudo rm -rf /opt/microsoft/msedge
          df -h /

      - name: Pull image
        run: docker pull "${{ inputs.container-image }}"

      - name: uv sync
        run: |
          docker run --rm -i \
            -v "$PWD:/home/rcdt/rcdt_robotics" -w /home/rcdt/rcdt_robotics --user root \
            --entrypoint /bin/bash "${{ inputs.container-image }}" -i -c "
              source /home/rcdt/.bashrc &&
              uv sync
            "

      - name: build workspace
        run: |
          docker run --rm -i \
            -v "$PWD:/home/rcdt/rcdt_robotics" -w /home/rcdt/rcdt_robotics --user root \
            --entrypoint /bin/bash "${{ inputs.container-image }}" -i -c "
              source /home/rcdt/.bashrc &&
              cd ros2_ws &&
              uv run colcon build --symlink-install
            "

      - name: ty check
        run: |
          docker run --rm -i \
            -v "$PWD:/home/rcdt/rcdt_robotics" -w /home/rcdt/rcdt_robotics --user root \
            --entrypoint /bin/bash "${{ inputs.container-image }}" -i -c "
              source /home/rcdt/.bashrc &&
              uv run ty check --error-on-warning
            "
      - name: Package build artifacts
        run: |
          docker run --rm -i \
            -v "$PWD:/home/rcdt/rcdt_robotics" \
            -w /home/rcdt/rcdt_robotics/ros2_ws --user root \
            --entrypoint /bin/bash "${{ inputs.container-image }}" -i -c "
              tar -czf /home/rcdt/rcdt_robotics/ros2_install.tgz install
            "

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ros2-install
          path: ros2_install.tgz
          retention-days: 1

  tests:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull image
        run: docker pull "${{ inputs.container-image }}"

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ros2-install
          path: .

      - name: Unpack build
        run: |
          tar -xzf ros2_install.tgz -C ros2_ws

      - name: tests
        run: |
          docker run --rm -i \
            -v "$PWD:/home/rcdt/rcdt_robotics" \
            -w /home/rcdt/rcdt_robotics --user root \
            --entrypoint /bin/bash "${{ inputs.container-image }}" -i -c "
              source /home/rcdt/.bashrc &&
              cd ros2_ws &&
              source install/setup.bash &&
              uv run pytest -s \
                --ignore=src/rcdt_franka/rcdt_franka/test/integration/test_franka_realsense.py \
                src/
            "

